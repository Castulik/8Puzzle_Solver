name: Deploy Flet App to Pages
on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install flet
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build Web
        run: flet publish mainWEB.py --base-url /8Puzzle_Solver/

      - name: Create COI Fix and Update Index
        run: |
          # 1. Vytvoření souboru coi-serviceworker.js přímo v dist složce
          cat <<EOF > dist/coi-serviceworker.js
          if(typeof window==="undefined"){self.addEventListener("install",()=>self.skipWaiting());self.addEventListener("activate",e=>e.waitUntil(self.clients.claim()));self.addEventListener("fetch",e=>{if(e.request.cache==="only-if-cached"&&e.request.mode!=="same-origin")return;e.respondWith(fetch(e.request).then(r=>{if(r.status===0)return r;const h=new Headers(r.headers);h.set("Cross-Origin-Embedder-Policy","credentialless");h.set("Cross-Origin-Opener-Policy","same-origin");return new Response(r.body,{status:r.status,statusText:r.statusText,headers:h})}).catch(e=>console.error(e)))});
          }else{const s=document.createElement("script");s.src=document.currentScript.src;s.dataset.cookie="coi";document.head.appendChild(s);if(window.crossOriginIsolated===false&&"serviceWorker"in navigator){navigator.serviceWorker.register(window.location.pathname+"coi-serviceworker.js");}
          }
          EOF
          
          # 2. Vložení skriptu do index.html (relativní cesta)
          sed -i 's/<head>/<head><script src="coi-serviceworker.js"><\/script>/' dist/index.html

      - name: Create .nojekyll
        run: touch dist/.nojekyll

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages